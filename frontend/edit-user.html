<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تعديل مستخدم - HNU</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="modules.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="logo.png" alt="HNU logo" class="brand-logo" />
      <span class="brand-text">HNU — النظام المحاسبي</span>
    </div>
  </header>
  <main class="container">
    <section class="module-card">
      <h2>تعديل المستخدم</h2>
      <form id="form-user">
        <input type="hidden" name="id" id="uid">
        <div class="row">
          <label>الاسم الكامل<br><input name="name" id="name" required></label>
          <label>البريد الإلكتروني<br><input name="email" id="email" type="email" required></label>
        </div>
        <div class="row">
          <label>كلمة المرور (اختياري)<br><input name="password" type="password"></label>
          <label>تأكيد كلمة المرور<br><input name="password2" type="password"></label>
        </div>
        <div class="row">
          <label>الدور<br>
            <select name="role" id="role">
              <option>مشرف</option>
              <option>محاسب</option>
              <option>عارض</option>
              <option>مشرف أعلى</option>
            </select>
          </label>
        </div>
        <button class="primary">حفظ التغييرات</button>
      </form>
    </section>
  </main>

  <script src="admin-modules.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    async function load(){
      const res = await AdminAPI.apiFetch('/api/users/list');
      const u = res.users.find(x=>x.id==id);
      if(!u){alert('المستخدم غير موجود');location.href='users-list.html';return}
      document.getElementById('uid').value=u.id;document.getElementById('name').value=u.name;document.getElementById('email').value=u.email;document.getElementById('role').value=u.role;
    }
    document.getElementById('form-user').addEventListener('submit',async function(e){
      e.preventDefault();
      const f=new FormData(e.target); const obj=Object.fromEntries(f.entries());
      if(obj.password && obj.password!==obj.password2){alert('كلمتا المرور غير متطابقتين');return}
      const payload = {id:parseInt(obj.id),name:obj.name,email:obj.email,role:obj.role};
      if(obj.password) payload.password=obj.password;
      const res = await AdminAPI.apiFetch('/api/users/update',{method:'POST',body:JSON.stringify(payload)});
      if(res.success){alert('تم الحفظ');location.href='users-list.html'} else alert(res.error||'خطأ');
    })
    load();
  </script>
</body>
</html>